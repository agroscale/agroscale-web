```{r setup, include=FALSE}
  knitr::opts_chunk$set(
  echo = TRUE,  collapse = TRUE, comment = "#>"
)
```

# QUEFTS

Here we show the use of the `QUEFTS` model. QUEFTS stands for *QUantitative Evaluation of the Fertility of Tropical Soils*. It is a simple and elegant model that can estimate the amount of fertilizer needed to reach a particular crop yield; or to estimate the crop yield given the amount of fertilizer applied. To run the model, you need soil and crop parameters, as well as the amount of fertilizer applied, and the attainable crop biomass production. In this context, the attainable production that is either the maximum production in the absence of nutrient limitation, or another (lower) target biomass production. 


## Technical background

QUEFTS was first described in 

B.H. Janssen, F.C.T. Guiking, D. van der Eijk, E.M.A. Smaling, J. Wolf and H.van Reuler. 1990. *A system for quantitative evaluation of the fertility of tropical soils (QUEFTS)*. `Geoderma 46: 299-318 <https://www.sciencedirect.com/science/article/pii/001670619090021Z>`__.


The model uses soil properties to estimate the potential soil supply of nitrogen (N), phosphorus (P) and potassium (K). This is done based on relationships between chemical properties of the topsoil and the maximum quantity of those nutrients that can be taken up by the crop, if no other nutrients limiting growth. This amount is crop and soil specific and can be determined through experiments where all other nutrients are in ample supply. The target nutrient thus becomes the most limiting, and the maximum soil supply of that nutrient can then be estimated from the crop's nutrient uptake, and related to soil properties such as pH, and organic carbon content (Janssen et al., 1990). The equations used by QUEFTS to calculate the potential supplies of nutrients from soil properties were derived from empirical data of field trials in Suriname and Kenya. They could be applicable to well drained, deep soils, that have a pH(H20) in the range 4.5â€“7.0, and values for organic carbon below 70 g/kg, P-Olsen below 30 mg/kg and exchangeable potassium below 30 mmol/kg.  


The actual uptake of each nutrient is estimated as a function of the potential soil supply of that nutrient, taking into account the potential soil supply of the other two nutrients, and the maximum nutrient concentrations in the vegetative and generative organs of the crop. 

The estimated uptake of nitrogen, phosphorus, and potassium is used to estimated biomass production ranges for each nutrient. For each pair of nutrients two yield estimates are calculated. For example the yield for the actual N uptake is computed dependent on the yield range for the P uptake, and that for the actual P uptake in dependent on the yield range for the N uptake. This leads to six combinations describing the uptake of one nutrient given maximum dilution or accumulation of another.

The nutrient-limited yield is then estimated by averaging the six yield estimates for paired nutrients. An estimate based on two nutrients may not exceed the upper limit of the yield range of the third nutrient, that is, the concentration of a nutrient can not be lower than its maximum dilution level. Neither may the yield estimates exceed the spacified maximum (attainable) production.


TO DO: illustrate the procedure numerically and graphically

TO DO: discuss limitations based on the Sattari et al paper


## Chapter requirements

We will use the R package `Rquefts`. It is not on CRAN yet (it will be there soon) but you can easily install it like this:

```{r} 
if (!require(Rquefts)) {
source("https://install-github.me/cropmodels/Rquefts")
}
```


## Create and run a model

The first step is to create a model. You can create a model with default parameters like this

```{r} 
library(Rquefts)
q <- quefts()
```

And then run the model

```{r} 
run(q)
```

You can also initialize a model with parameters of you choice

```{r} 
soiltype <- quefts_soil()
barley <- quefts_crop('Barley')
fertilizer <- list(N=50, P=0, K=0)
biomass <- list(leaf_att=2200, stem_att=2700, store_att=4800, SeasonLength=110)
q <- quefts(soiltype, barley, fertilizer, biomass)
```


TODO discuss parameters


If the crop has biological nitrogen fixation (in symbiosis with *Rhizobium*) you can use the NFIX parameter to determine the fraction of the total nitrogen supply that is supplied by biological fixation. Note that NFIX is a constant, while in reality nitrogen fixation is amongst other things dependent on the amount of mineral nitrogen available in the soil.


## Explore 

```{r}

library(Rquefts)

rice <- quefts_crop("Barley")
q <- quefts(crop=rice)
q$leaf_att <- 2651
q$stem_att <- 5053
q$store_att <- 8208

fert(q) <- list(N=0, P=0, K=0)
N <- seq(1, 200, 10)

results <- matrix(nrow=length(N), ncol=12)
colnames(results) <- names(run(q))
for (i in 1:length(N)) {
	q["N"] <- N[i]
	results[i,] <- run(q)
}

yield <- results[,"store_lim"]

par(mfrow=c(1,2))
plot(N, yield, type="l", lwd=2)
Efficiency = yield / N
plot(N, Efficiency, type="l", lwd=2)
```



## Callibration

Here I illustrate some basic approaches that can be used for callibration.  First I generate some data. 

```{r} 
set.seed(99)
yldfun <- function(N, noise=TRUE) { 1000 +  500* log(N+1)/3 + noise * runif(length(N), -500, 500) }
N <- seq(0,300,25)
Y <- replicate(10, yldfun(N))
obs <- cbind(N, Y)
```

We will use Root Mean Square Error (RMSE) to assess model fit. 

```{r} 
RMSE <- function(obs, pred) sqrt(mean((obs - pred)^2))
```

Let's see how good the default parameters work for us.

```{r} 
q <- quefts()
q$P <- 0
q$K <- 0

results <- matrix(nrow=length(N), ncol=12)
colnames(results) <- names(run(q))
for (i in 1:length(N)) {
	q$N <- N[i]
	results[i,] <- run(q)
}

yield <- results[,'store_lim']
RMSE(obs[,-1], yield)
```

The RMSE is quite high. 

Create a function to minimize with the optimizer. Here I try to improve the model by altering four parameters.

```{r} 

vars <- c('soil$N_base_supply', 'soil$N_recovery', 'crop$NminStore', 'crop$NmaxStore')

f <- function(p) {
	if (any (p < 0)) return(Inf)
	if (p['crop$NminStore'] >= p['crop$NmaxStore']) return(Inf)
	if (p['soil$N_recovery'] > .6 | p['soil$N_recovery'] < .3) return(Inf)
	q[names(p)] <- p
	pred <- run(q)
	RMSE(obs[,-1], pred['store_lim'])
}

# try the function with some initial values
x <- c(50, 0.5,  0.011, 0.035)
names(x) <- vars
f(x)
```

Now optimize

```{r} 
par <- optim(x, f)
# RMSE
par$value
# optimal parameters
par$par
```

