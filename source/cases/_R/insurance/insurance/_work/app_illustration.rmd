# Evaluation

## Remote sensing based index for detecting yield variability

To place this into perspective, let us use the Makindube data and compute income $y_{izt}$ of a farmer based on area yields assuming the price of rice per kg is 0.35 USD. 

Load data.

```{r a1, message=FALSE}
library(agrins)
d <- data_rice("yield")
head(d, n=2)
```
Let us examine a farmer *i*'s utility for 10 years. First extract data with complete case and compute income in dollars.

```{r a2}
i <- d[,c("fid","year","y_it")]
i <- i[complete.cases(i$y_it) & i$y_it != 0 ,]
#compute income
i$y_it <- i$y_it * 0.35

```

Now let us extract farmers with income for the entire 10 years.

```{r a3, message=FALSE}
library(dplyr)
options(warn = 1)
# count number of occurrences of fid between 2003-2012
freq <- summarise(group_by(i,fid,year,y_it), count  = n())
#aggregate and select fid with years with frequency of 10
id <- aggregate(count~fid,data=freq,sum)
id <- id[id$count>=10,]
# farmers with income of 10 years
fid <- sort(id$fid)

```
Graph utility for a farmer with *fid=7* using $rho$ values of 0.5, 1 and 1.5.

```{r a4, out.width = '100%'}
income <- i$y_it[i$fid==fid[2]]
u1 = utility(income, 0.5)
u2 = utility(income, 1)
u3 = utility(income, 1.5)
plot(sort(income), sort(u1), lwd=2, xlim = range(income), ylim=range(min(u3-1):max(u1)), col="red", xlab="income", ylab="utility", type="l")
lines(sort(income), sort(u2), lwd=2, col="black")
lines(sort(income), sort(u3), lwd=2, col="orange")
legend("topright", lty = 1, col = c("red", "black", "green"), legend=c('0.5','1.0', "1.5"), title = "CRRA")

```
We have used the *utility function* to determine how much a farmer *fid=7* dreads the bad state of the world. Let us now determine what income a the farmer is willing to have to avoid a bad state. This income is called **Certainty Equivalence** (CE). CE expresses how much money someone is willing to give up to avoid all risk. This can be determined using expected utility based on the following function. 

```{r CE01}
library(agrins)
agrins::ce_utility
```

Note that, *expected utility* is the mean of utilities computed from the farmer's income over time *t*. Therefore, before we compute CE of this farmer we need to first compute utility. To accomplish that, we can combine the two functions into one to directly compute the CE from income and *rho*. 

Use the function to compute CE for the farmer (*fid=7*) with $0 \leq \rho \leq 2$. 

```{r CE02, out.width = '100%'}
rho <- seq(0,2,0.1)
ce  <- array(NA, dim=length(rho))
for(i in 1:length(rho)){
  ce[i] <- agrins::ce_income(income, rho=rho[i])
}
plot(rho,ce, type="l", xlab = "Risk aversion", ylab ="Certainty Equivalent [$]", col="red")

ce[1]==mean(income)

```

What does this mean? Basically, a risk neutral person is willing to give up their average income which in this case is equivalent to their CE.

## Insurance

By measuring utility of a farmer/household with or without insurance, we can be able to compare insurance products. The best insurance products are those that provide farmers the highest average utility. 

Assume that our farmer *fid=7* receives payouts equal to how low his/her income is from a given **trigger** value multiplied by their average over 10 years.

```{r ins2}
payout <- function(income, trigger){
  mu <- mean(income)
  trigger_val <- trigger * mu
  ifelse(income < trigger_val,
                  trigger_val - income, 
                  0)
}

payouts <- payout(income, trigger=1)
nopay     <- sum(payouts==0)
cat("The farmer did not receive payouts ", nopay, " times out the 10 years. \n") 

```

Let us now compute insurance premium paid by this farmer. Normally the insurance is marked up to cater for administrative costs. From the perspective of the client, a contract is **actuarially fair** if the premiums paid are equal to the expected value of compensation (payouts) paid. Therefore, we can estimate the premium from the average payouts received by a  client multiplied by some mark-up. 

```{r ins3}
# The actuarially fair price (afp) equals the premium when markup equals 0
markup <-  0.0
premium <- mean(payouts) * (1+markup)
premium

```

Now subtract the cost of the premium from income (this is an expense). Then plot make plots of income with and without insurance. What do you learn?

```{r ins4}
income_with_insurance =  income + payouts - premium
plot(income, income, col="red",  xlim=range(income), ylim=range(income), type="l")
lines(sort(income), sort(income_with_insurance), xlim=range(income), ylim=range(income_with_insurance), type="l", col="green")
legend("bottomright", lty = 1, col = c("red", "green"), legend=c('Income without insurance','Income with insurance'))

```

Basically, we can see that insurance cushioned this farmer when their income fell below the average income in 10 years. During the good states of the world the income of the farmer with insurance was lower than without because an individual incurs insurance premium cost. We can perceive this also by computing absolute and relative benefit of insurance and graphing it as below.

```{r ins4b}
benefit <- income_with_insurance - income 
plot(sort(benefit), ylab="absolute benefit", xlab="Period (years)", type="l")
abline(v=nopay, col = "red")
text(nopay, max(benefit), "Paid", srt=0.2, col = "green", pos=4)
text(nopay, max(benefit), "Nopay", col = "red", pos=1)

plot(sort(benefit /  income), ylab="relative benefit", xlab="Period (years)", type = "l")
abline(v=nopay, col = "red")
text(nopay, max(benefit /income), "Paid", srt=0.2, col = "green", pos=4)
text(nopay, max(benefit /  income), "Nopay", col = "red", pos=1)

```

The next thing we wish to evaluate is if this insurance scheme was beneficial at all to the individual. Let us compute CE with and without insurance using $0 \leq rho \leq 5$. Add an insurance mark up of 25% and 75% then compare to previous one with 0 mark up.

```{r ins5}
rho <- seq(0,5,1)

markup <- 0.75
premium <- mean(payouts) * (1+markup)
income_ins75 <-  income + payouts - premium
ce_ins75    <- array(NA, dim=length(rho))

markup <- 0.25
premium <- mean(payouts) * (1+markup)
income_ins25 <-  income + payouts - premium
ce_ins25    <- array(NA, dim=length(rho))

markup <- 0
premium <- mean(payouts) * (1+markup)
income_ins_no_markup <-  income + payouts - premium
ce_ins_no_markup  <- array(NA, dim=length(rho))
ce_no_ins <- array(NA, dim=length(rho))
for(i in 1:length(rho)){
  ce_ins_no_markup[i] <- ce_income(income_ins_no_markup, rho=rho[i])
  ce_ins75[i]   <- ce_income(income_ins75, rho=rho[i])
  ce_ins25[i]   <- ce_income(income_ins25, rho=rho[i])
  ce_no_ins[i] <- ce_income(income, rho=rho[i])
}

```

Plot CE with and without insurance over the ranges of $rho$ used previously.

```{r ins6}
plot(rho, ce_no_ins, type="l",  col = "black", ylab ="Certainty Equivalent [$]", xlab ="Risk Aversion Coefficient", ylim=c(min(ce_no_ins)-200, max(ce_no_ins)))
lines(rho, ce_ins75, col = "blue")
lines(rho, ce_ins25, col = "green")
lines(rho, ce_ins_no_markup, col = "red")
legend("bottomleft", c('No Insurance', "75% Mark up", "25% Mark up", 'No mark up'), lty = 1, col = c("black", "blue", "green","red"), bty="n", ncol=2)


```
The plots illustrates measured well being of the farmer in certain income equivalents under different risk (CRRA). For instance, the insurance does not help if risk is neutral while the help diminishes as mark-up increases from 25% to 75%. If the farmer decides to go it alone then his/her average income is 1372 USD, but its certainty equivalent is only 1335.25 USD when $\rho= 2$. When insurance is marked-up 25% it passes the MQS test (as demonstrated later) if the farmer is above average risk averse $\rho \geq 2.5$. When insurance is 75% marked-up it is not suitable at all to this farmer.

Now let us determine if this insurance contract passes the welfare test ( -1 is bad, 0 is no effect, 1 is good) using Minimum Quality Standard (MQS) test. The MQS test goal is to answer the question; "would a household be better off without insurance or with insurance?" If the farmer would be better off economically buying insurance, then we will say that the insurance contract meets the Minimum Quality Standard (MQS) hence 1.


```{r mqs01}
mqs <- function(ce_insured, ce_not_insured) {
   m = sign(ce_insured - ce_not_insured)
   c("bad", "neutral", "good")[m+2]
}

```

Use the MQS function to perform welfare test. To accomplish this, we will use already computed CE with and without insurance using risk aversion values $0 \leq rho \leq 2$. 

```{r mqs02}
#Test for 75% mark up
mqs75 <- mqs(ce_ins75, ce_no_ins)
data.frame(mqs75, rho)
#Test for 25% mark up
mqs25 <- mqs(ce_ins25, ce_no_ins)
data.frame(mqs25, rho)
#Test for no mark up
mqs_nomarkup <- mqs(ce_ins_no_markup, ce_no_ins)
data.frame(mqs_nomarkup, rho)

```

In this section we have illustrated principle of insurance evaluation using income of one farmer. However, in reality evaluation of insurance contracts at individual level may not be the best apprpach because of moral hazard. In this case insurance contracts normally given to farmers in following some zones where payouts are also computed. The [next section](area_yield.html) will illustrate this principle as applied to area yield contract.
